<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
    Copyright (C) 2006-2025 Carnegie Mellon University
    See license information in LICENSE.txt.
-->
<!--
    @DISTRIBUTION_STATEMENT_BEGIN@
    YAF 2.16
    Copyright 2024 Carnegie Mellon University.
    NO WARRANTY. THIS CARNEGIE MELLON UNIVERSITY AND SOFTWARE ENGINEERING
    INSTITUTE MATERIAL IS FURNISHED ON AN "AS-IS" BASIS. CARNEGIE MELLON
    UNIVERSITY MAKES NO WARRANTIES OF ANY KIND, EITHER EXPRESSED OR IMPLIED,
    AS TO ANY MATTER INCLUDING, BUT NOT LIMITED TO, WARRANTY OF FITNESS FOR
    PURPOSE OR MERCHANTABILITY, EXCLUSIVITY, OR RESULTS OBTAINED FROM USE OF
    THE MATERIAL. CARNEGIE MELLON UNIVERSITY DOES NOT MAKE ANY WARRANTY OF
    ANY KIND WITH RESPECT TO FREEDOM FROM PATENT, TRADEMARK, OR COPYRIGHT
    INFRINGEMENT.
    Licensed under a GNU GPL 2.0-style license, please see LICENSE.txt or
    contact permission@sei.cmu.edu for full terms.
    [DISTRIBUTION STATEMENT A] This material has been approved for public
    release and unlimited distribution.  Please see Copyright notice for
    non-US Government use and distribution.
    This Software includes and/or makes use of Third-Party Software each
    subject to its own license.
    DM24-1063
    @DISTRIBUTION_STATEMENT_END@
-->
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YAF: Configuring YAF with super_mediator and SiLK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Tutorials</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Configuring YAF with super_mediator and SiLK</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_yaf-2_816_84_2doc_2howto_2yaf__super__silk"></a></p>
<p>This tutorial is a step-by-step guide of setting up <b>yaf</b>, <a href="https://tools.netsa.cert.org/super_mediator1/index.html">super_mediator</a>, and <a href="https://tools.netsa.cert.org/silk/index.html">SiLK</a>.</p>
<ul>
<li><a class="el" href="#yss_overview">Overview</a></li>
<li><a class="el" href="#yss_install">Basic Install</a><ul>
<li><a class="el" href="#yss_mysql">Setup MySQL Database</a></li>
</ul>
</li>
<li><a class="el" href="#yss_silk">Configure SiLK</a></li>
<li><a class="el" href="#yss_sm">Configure super_mediator</a></li>
<li><a class="el" href="#yss_goyaf">Run YAF</a></li>
<li><a class="el" href="#yss_analysis">Analysis with MySQL/SiLK</a></li>
</ul>
<h1><a class="anchor" id="yss_overview"></a><a href="#yss_overview">
Overview</a></h1>
<p>Check out this <a href="https://tools.netsa.cert.org/super_mediator1/sm_guide.html">tutorial</a> for information on what super_mediator is and what data it can produce. This particular tutorial shows how super_mediator can insert the DPI data produced by <b>yaf</b> into a MySQL database. super_mediator will perform DNS deduplication on DNS resource records. This tutorial also shows how to do a basic install of SiLK and have <b>super_mediator</b> forward all the flows it receives to SiLK.</p>
<h1><a class="anchor" id="yss_install"></a><a href="#yss_install">
Install prerequisites</a></h1>
<pre class="fragment">$ yum groupinstall "Development Tools"
$ yum install libpcap-devel pcre-devel mysql-server mysql-devel
</pre><p> Build <a href="https://tools.netsa.cert.org/fixbuf2/index.html">libfixbuf</a>: </p><pre class="fragment">$ tar -xvzf libfixbuf-2.3.0.tar.gz
$ cd libfixbuf-2.3.0
$ ./configure
$ make
$ make install
</pre><p> Build <b>yaf</b>: </p><pre class="fragment">$ tar -xvzf yaf-2.13.0.tar.gz
$ cd yaf-2.13.0
$ ./configure --enable-applabel --enable-plugins
$ make
$ make install
</pre><p> Build <b>super_mediator</b>: </p><pre class="fragment">$ tar -xvzf super_mediator-1.8.0.tar.gz
$ cd super_mediator-1.8.0
$ ./configure --with-mysql
$ make
$ make install
</pre><p> Build <a href="https://tools.netsa.cert.org/silk/index.html">SiLK</a>: </p><pre class="fragment">$ tar -xvzf silk-3.11.0.tar.gz
$ cd silk-3.11.0
$ ./configure --with-libfixbuf=/usr/local/lib/pkgconfig --enable-ipv6
$ make
$ make install
</pre> <h2><a class="anchor" id="yss_mysql"></a><a href="#yss_mysql">
Setup the MySQL Database</a></h2>
<p>Setup mysqld </p><pre class="fragment">$ service mysqld start
</pre><p> Setup a password for the root user </p><pre class="fragment">$ /usr/bin/mysqladmin -u root password '&lt;SuperSecretPassword&gt;'
</pre><p> Login to the database (It will prompt you for the password you created in the last step): </p><pre class="fragment">$ mysql -u root -p
</pre><p> Create the database you intend to use for super_mediator: </p><pre class="fragment">mysql&gt; create database smediator;
</pre><p> Create a user for super_mediator to access the database: </p><pre class="fragment">mysql&gt; CREATE USER 'mediator'@'localhost' IDENTIFIED BY '&lt;SuperSecretPassword&gt;';
</pre><p> Giver permissions to user to access only the smediator database: </p><pre class="fragment">mysql&gt; GRANT ALL ON smediator.* TO mediator@'localhost';
</pre> <h1><a class="anchor" id="yss_silk"></a><a href="#yss_silk">
Setup SiLK</a></h1>
<p>We will using /data as the location of our SiLK repository: </p><pre class="fragment">$ mkdir -p /data
</pre><p> We will be using the default silk.conf file so copy it to the repo now: </p><pre class="fragment">$ cp site/twoway/silk.conf /data
$ cp src/rwflowpack/rwflowpack.conf /usr/local/etc/rwflowpack.conf
$ cp src/rwflowpack/rwflowpack.init.d /etc/init.d/rwflowpack
$ chmod +x /etc/init.d/rwflowpack
</pre><p> To configure <b>rwflowpack</b>, edit <code>/usr/local/etc/rwflowpack.conf</code> </p><pre class="fragment">#/usr/local/etc/rwflowpack.conf
ENABLED=1
statedirectory=/var/lib/rwflowpack
CREATE_DIRECTORIES=yes
BIN_DIR=/usr/local/sbin
SENSOR_CONFIG=/data/sensor.conf
DATA_ROOTDIR=/data
SITE_CONFIG=/data/silk.conf
PACKING_LOGIC=
INPUT_MODE=stream
INCOMING_DIR=${statedirectory}/incoming
ARCHIVE_DIR=${statedirectory}/archive
FLAT_ARCHIVE=0
ERROR_DIR=  #${statedirectory}/error
OUTPUT_MODE=local
SENDER_DIR=${statedirectory}/sender-incoming
INCREMENTAL_DIR=${statedirectory}/incremental
COMPRESSION_TYPE=
POLLING_INTERVAL=
FLUSH_TIMEOUT=
FILE_CACHE_SIZE=
FILE_LOCKING=1
PACK_INTERFACES=0
LOG_TYPE=syslog
LOG_LEVEL=info
LOG_DIR=${statedirectory}/log
PID_DIR=${LOG_DIR}
USER=root
EXTRA_OPTIONS=
</pre><p> We will need to create the Sensor configuration file <a href="https://tools.netsa.cert.org/silk/sensor.conf.html">sensor.conf</a> to setup the listening probe. Change the internal-ipblocks to match your network </p><pre class="fragment">probe S0 ipfix
   listen-on-port 18001
   protocol tcp
end probe

sensor S0
   ipfix-probes S0
   internal-ipblocks 192.168.1.0/24 10.10.10.0/24
   external-ipblocks remainder
end sensor
</pre><p> Move the sensor.conf to the repository: </p><pre class="fragment">$ mv sensor.conf /data
</pre><p> Start <b>rwflowpack</b> using either <b>systemctl</b> or <b>service</b>: </p><pre class="fragment">$ systemctl start rwflowpack

$ service rwflowpack start
</pre><p> Verify that rwflowpack is listening on port 18001: </p><pre class="fragment">$ netstat -vnatpl
</pre><p> To use the SiLK command line tools, you need to set the <b>SILK_DATA_ROOTDIR</b> variable: </p><pre class="fragment">$ export SILK_DATA_ROOTDIR=/data
</pre> <h1><a class="anchor" id="yss_sm"></a><a href="#yss_sm">
Setup super_mediator</a></h1>
<p>Create the file directories that <b>super_mediator</b> will use to write files that will eventually get imported into the MySQL Database. </p><pre class="fragment">$ mkdir -p /data/smediator/dpi
$ mkdir -p /data/smediator/dns
</pre><p> Use <b>super_table_creator</b> to create all the tables in your database: </p><pre class="fragment">$ /usr/local/bin/super_table_creator --name mediator \
    --pass=&lt;SuperSecretPassword&gt; --database=smediator
$ /usr/local/bin/super_table_creator --name mediator \
    --pass=&lt;SuperSecretPassword&gt; \
--database=smediator --dns-dedup
</pre><p> Create your super_mediator.conf file. One is installed by default into /usr/local/etc. The following one will get you started: </p><pre class="fragment">COLLECTOR TCP
   PORT 18000
COLLECTOR END

#rwflowpack
EXPORTER TCP
   PORT 18001
   HOST localhost
   FLOW_ONLY
EXPORTER END

#dedup process

EXPORTER TEXT
   PATH "/data/smediator/dns/yaf2dns"
   DELIMITER "|"
   ROTATE 1200
   DNS_DEDUP_ONLY
   LOCK
   MYSQL_USER "mediator"
   MYSQL_PASSWORD "&lt;SuperSecretPassword&gt;"
   MYSQL_TABLE "dns-dedup"
   MYSQL_DATABASE "smediator"
EXPORTER END

#dpi 2 database
EXPORTER TEXT
   PATH "/data/smediator/dpi"
   ROTATE 1200
   MULTI_FILES
   DPI_ONLY
   LOCK
   MYSQL_USER "mediator"
   MYSQL_PASSWORD "&lt;SuperSecretPassword&gt;"
   MYSQL_DATABASE "smediator"
EXPORTER END

DNS_DEDUP
   MAX_HIT_COUNT 5000
DNS_DEDUP END

LOGLEVEL DEBUG

LOG "/var/log/super_mediator.log"

PIDFILE "/data/super_mediator.pid"
</pre><p> Start <b>super_mediator</b>: </p><pre class="fragment">$ super_mediator -c /usr/local/etc/super_mediator.conf --daemonize
</pre><p> Confirm <b>super_mediator</b> is running: </p><pre class="fragment">$ ps -ef | grep super
</pre><p> If <b>super_mediator</b> is not running, check for any errors: </p><pre class="fragment">$ cat /var/log/super_mediator.log
</pre> <h1><a class="anchor" id="yss_goyaf"></a><a href="#yss_goyaf">
Start YAF</a></h1>
<pre class="fragment">$ mkdir /var/log/yaf

$ export LTDL_LIBRARY_PATH=/usr/local/lib/yaf
</pre><p> Example <b>yaf</b> command line for processing a PCAP file: </p><pre class="fragment">/usr/local/bin/yaf
--in &lt;PCAP FILE&gt; \
--ipfix tcp \
--out localhost \
--log /var/log/yaf/yaf.log \
--verbose \
--silk \
--verbose \
--ipfix-port=18000 \
--applabel --max-payload 2048 \
--plugin-name=/usr/local/lib/yaf/dpacketplugin.so
</pre><p> Example <b>yaf</b> command line for sniffing interface eth0: </p><pre class="fragment">/usr/local/bin/yaf
--in eth0 --live pcap \
--ipfix tcp \
--out localhost \
--log /var/log/yaf/yaf.log \
--verbose \
--silk \
--verbose \
--ipfix-port=18000 \
--applabel --max-payload 2048 \
--plugin-name=/usr/local/lib/yaf/dpacketplugin.so
</pre> <h1><a class="anchor" id="yss_analysis"></a><a href="#yss_analysis">
Confirm Install and Sample Analysis</a></h1>
<p>Confirm MySQL database contains data: </p><pre class="fragment">$ mysql -u root -p

mysql&gt; use smediator;

mysql&gt; select table_name, table_rows from information_schema.tables where table_schema = DATABASE();
+-------------+------------+
| table_name  | table_rows |
+-------------+------------+
| dhcp        |          0 |
| dns         |      73414 |
| flow        |      39946 |
| ftp         |         36 |
| http        |      77462 |
| imap        |         78 |
| irc         |        224 |
| mysql       |          0 |
| nntp        |          0 |
| p0f         |          0 |
| pop3        |         12 |
| rtsp        |          0 |
| sip         |          0 |
| slp         |          0 |
| smtp        |         96 |
| ssh         |         44 |
| tftp        |          0 |
| tls         |      34370 |
+-------------+------------+
</pre><p> Confirm SiLK is creating flow records: </p><pre class="fragment">$ rwfilter --proto=0- --type=all --pass=stdout | rwcut | head
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</body>
</html>

